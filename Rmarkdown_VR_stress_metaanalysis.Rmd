---
title: "VR_stress_meta-analysis"
author: "Tor Finseth"
date: "1/22/2021"
output: 
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#NOTE: you will need to install these packages when you run it the first time.
#install.packages("metafor")
#install.packages("googlesheets4")
#install.packages("ggplot2")
#install.packages("dplyr")
#install.packages("greekLetters")
library(googlesheets4)
library(metafor) # see https://wviechtb.github.io/metafor/ for documentataion and function descriptions
library(ggplot2)
library(plyr)
library(dplyr)
library(greekLetters)

```

```{r}
#read the google spreadsheet
gs4_deauth()
VR_study_sprdsht <- read_sheet("https://docs.google.com/spreadsheets/d/113KZYiODuhNoohl2VNSJcs1sUsDmpp_5mnv5egAPHW4/edit?usp=sharing", range = "Outcomes - Consensus!A2:DD44")
numrows=nrow(VR_study_sprdsht)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, fig.width=6,fig.height=4} 
######################## CORT #######################################

#Calculate cort effect size
cort_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(6))))#baseline  #select the columns you want, then convert from list to numeric array
cort_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(11)))) #peak
cort_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(7)) ))
cort_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(12)))) 
cort_n2i=as.numeric(unlist(select(VR_study_sprdsht,c(10))))
cort_n1i=as.numeric(unlist(select(VR_study_sprdsht,c(15))))

dat <-escalc(measure="SMCC", ni=cort_n2i, m1i=cort_m1i, m2i=cort_m2i, sd1i=cort_sd1i, sd2i=cort_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 
#NOTE: yi=vector to specify the observed effects or outcomes, vi=vector to specify the corresponding sampling variances.
#NOte: Is your meta-analysis testing differences across alternate treatments or experimental conditions? If so, the raw score standardization (SMCR) is preferable. If your meta-analysis is primarily concerned with changes in individuals, the change score standardization (SMCC) is better.


#### CORT FUNNEL PLOT, see https://wviechtb.github.io/metafor/reference/funnel.html#examples ####
### random-effects model
res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat,  slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

### show effect size values on x-axis ,label points outside of the pseudo confidence interval region
#mu=symbol("mu");
mes=paste("Standardized Mean Change in Cortisol (",greek$mu,"g/dl)")
taf <- trimfill(res) #trim-and-fill analysis
funnel(taf, xlab=mes, legend=TRUE) # add ", atransf=exp" in the parentheses to log scale the x-axis
```

```{r, fig.width=10,fig.height=4} 
#NOTE:widen plotting device to avoid overlapping text

### CORT FOREST PLOT, see https://wviechtb.github.io/metafor/reference/forest.rma.html#examples ##
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,7), 
       ilab=cbind(cort_m2i, cort_sd2i, cort_m1i, cort_sd1i, cort_n2i),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
        mlab=" ")

op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5, -2.5), 14, c("M", "SD", "M", "SD", "N")) # value six denotes the height,posy
text(c(-8.75,-5.25),     15, c("Baseline", "Peak")) # value three denotes the height,posy
par(op) # resets the plotting parameters.
addpoly(res2, row=-1.7, cex=0.75, mlab="")

### add text with Q-value, dfs, p-value, and I^2 statistic
text(-20, -0.8, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.7, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))

#trim-and-fill anlaysis
res
taf
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```
```{r}
#### CORT MODERATORS ###
# see http://scholar.google.com/scholar_url?url=https://lirias.kuleuven.be/retrieve/437872&hl=en&sa=X&ei=0WUJYYVUkezJBM-RpKgO&scisig=AAGBfm115s1i7JeurgWhwB2gASae5BODsA&nossl=1&oi=scholarr, pg 12.

#USE THE VALUES FROM THE RANDOM-EFFECT NULL MODEL
# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c
#Note: if residual heterogeneity is significant (QE = 24.7, df = 8, p=0.017), this possibly indicates that other moderators not considered in the model are influencing the VR effects on Cort.

#preds <- predict(res_mod_age_c, newmods = cbind(0:60))
#wi <- 1/sqrt(dat$vi)
#size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
#plot(age, dat$yi, pch = 19, cex = size, xlab = "Age", ylab = "Change in Cort", las = 1, bty = "l", log = "y", main="SMC of Cort versus Age",)
# lines(0:60, preds$pred)
# lines(0:60, preds$ci.lb, lty = "dashed")
# lines(0:60, preds$ci.ub, lty = "dashed")

 regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of Cort versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of Cort versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in Cort", xaxt="n", bty = "l", main="SMC of Cort versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
VR_medium=as.factor(unlist(select(VR_study_sprdsht,c(105))))
res_mod_VR_medium <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_medium) #doesnt matter if weighted or not. Same results.
res_mod_VR_medium
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_medium, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_medium, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in Cort", xaxt="n", bty = "l", main="SMC of Cort versus VR medium")
axis(side=1, at=1:2, labels=c("HMD","CAVE"))

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of Cort versus Year of Publication",)

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in Cort", xaxt="n", bty = "l", main="SMC of Cort versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of Cort versus Subjective Stress of VR Simulation",)

#TSST vs non-TSST
VR_TSST=as.factor(unlist(select(VR_study_sprdsht,c(107))))
res_mod_VR_TSST <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_TSST) #doesnt matter if weighted or not. Same results.
res_mod_VR_TSST

preds <- predict(res_mod_VR_TSST, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_TSST, dat$yi, type="o", pch = 19, xlab = "VR Stressor", ylab = "Change in Cort", xaxt="n", bty = "l", main="SMC of Cort versus TSST or Non-TSST setting")
axis(side=1, at=1:2, labels=c("Non-TSST","TSST"))

#under 25 vs. over 25
VR_uo=as.factor(unlist(select(VR_study_sprdsht,c(108))))
res_mod_VR_uo <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_uo) #doesnt matter if weighted or not. Same results.
res_mod_VR_uo

preds <- predict(res_mod_VR_uo, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_uo, dat$yi, type="o", pch = 19, xlab = "VR Stressor", ylab = "Change in Cort", xaxt="n", bty = "l", main="SMC of Cort versus under-25 or over-25 years of age")
axis(side=1, at=1:2, labels=c("under-25","over-25"))

#Sample Size
SampleS=as.numeric(unlist(select(VR_study_sprdsht,c(10))))
res_mod_Stress_sample <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ SampleS)
res_mod_Stress_sample

regplot(res_mod_Stress_sample, mod="SampleS", xlab="Sample Size",
         refline=1, legend=TRUE, main="SMC of Cort versus Sample Size",)

```



```{r, fig.width=6,fig.height=4}
######################## HEART RATE #######################################

#Calculate HR effect size
HR_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(26))))#baseline  #select the columns you want, then convert from list to numeric array
HR_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(31)))) #peak
HR_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(27)) ))
HR_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(32)))) 
HR_n2i=as.numeric(unlist(select(VR_study_sprdsht,c(30))))
HR_n1i=as.numeric(unlist(select(VR_study_sprdsht,c(35))))

dat <-escalc(measure="SMCC", ni=HR_n1i, m1i=HR_m1i, m2i=HR_m2i, sd1i=HR_sd1i, sd2i=HR_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 

res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

taf <- trimfill(res) #trim-and-fill analysis, I^2 >70%
funnel(taf, xlab="Standardized Mean Change in Heart Rate (BPM)", legend=TRUE)
```

```{r, fig.width=10,fig.height=7}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(HR_m2i, HR_sd2i, HR_m1i, HR_sd1i, HR_n1i),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5,-2.5), 37, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-8.75,-5.25),     38, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-2, cex=0.75, mlab="")
text(-20, -0.8, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -2, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))

res
taf
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2

```

```{r}
#### HR MODERATORS ###


# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of Heart Rate versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of Heart Rate versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in Heart Rate", xaxt="n", bty = "l", main="SMC of Heart Rate versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
VR_medium=as.factor(unlist(select(VR_study_sprdsht,c(105))))
res_mod_VR_medium <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_medium) #doesnt matter if weighted or not. Same results.
res_mod_VR_medium
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_medium, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_medium, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in Heart Rate", xaxt="n", bty = "l", main="SMC of Heart Rate versus VR medium")
axis(side=1, at=1:2, labels=c("HMD","CAVE"))

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of Heart Rate versus Year of Publication",)

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in HR", xaxt="n", bty = "l", main="SMC of HR versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of HR versus Subjective Stress of VR Simulation",)

#TSST vs non-TSST
VR_TSST=as.factor(unlist(select(VR_study_sprdsht,c(107))))
res_mod_VR_TSST <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_TSST) #doesnt matter if weighted or not. Same results.
res_mod_VR_TSST

preds <- predict(res_mod_VR_TSST, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_TSST, dat$yi, type="o", pch = 19, xlab = "VR Stressor", ylab = "Change in HR", xaxt="n", bty = "l", main="SMC of HR versus TSST or Non-TSST setting")
axis(side=1, at=1:2, labels=c("Non-TSST","TSST"))
  dat2=data.frame(dat$yi, VR_TSST)
  mean_group <- ddply(dat2, c("VR_TSST"), summarise, 
                      mean=mean(dat.yi, na.rm=TRUE),
                      sd   = sd(dat.yi, na.rm=TRUE)
               )
  mean_group

#under 25 vs. over 25
VR_uo=as.factor(unlist(select(VR_study_sprdsht,c(108))))
res_mod_VR_uo <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_uo) #doesnt matter if weighted or not. Same results.
res_mod_VR_uo

preds <- predict(res_mod_VR_uo, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_uo, dat$yi, type="o", pch = 19, xlab = "VR Stressor", ylab = "Change in HR", xaxt="n", bty = "l", main="SMC of HR versus under-25 or over-25 years of age")
axis(side=1, at=1:2, labels=c("under-25","over-25"))

#Sample Size
SampleS=as.numeric(unlist(select(VR_study_sprdsht,c(30))))
res_mod_Stress_sample <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ SampleS)
res_mod_Stress_sample

regplot(res_mod_Stress_sample, mod="SampleS", xlab="Sample Size",
         refline=1, legend=TRUE, main="SMC of Heart Rate versus Sample Size",)

```

```{r, fig.width=6,fig.height=4}

#########SKIN CONDUCTANCE ####################
#Calculate SC effect size
SC_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(86))))#baseline  #select the columns you want, then convert from list to numeric array
SC_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(91)))) #peak 
SC_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(87)) )) 
SC_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(92)))) 
SC_n2i=as.numeric(unlist(select(VR_study_sprdsht,c(90)))) 
SC_n1i=as.numeric(unlist(select(VR_study_sprdsht,c(95)))) 

dat <-escalc(measure="SMCC", ni=SC_n1i, m1i=SC_m1i, m2i=SC_m2i, sd1i=SC_sd1i, sd2i=SC_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 


res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
mes=paste("Standardized Mean Change in GSR (", greek$mu,"S)")
#taf <- trimfill(res) #trim-and-fill analysis
funnel(res, xlab=mes, legend=TRUE)
```

```{r, fig.width=10,fig.height=4}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(SC_m2i, SC_sd2i, SC_m1i, SC_sd1i, SC_n1i),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5, -2.5), 11, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-8.75,-5.25),     11.7, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-1.8, cex=0.75, mlab="")
text(-20, -0.8, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.6, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))
res
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```
```{r}
#### EDA MODERATORS ###

# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of EDA versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of EDA versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in EDA", xaxt="n", bty = "l", main="SMC of EDA versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
# NOTE: NO STUDIES USING CAVES MEASURED EDA, SO THIS ANALYSIS CANNOT BE PREFORMED

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of EDA versus Year of Publication",)

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in EDA", xaxt="n", bty = "l", main="SMC of EDA versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of EDA versus Subjective Stress of VR Simulation",)

#TSST vs non-TSST
VR_TSST=as.factor(unlist(select(VR_study_sprdsht,c(107))))
res_mod_VR_TSST <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_TSST) #doesnt matter if weighted or not. Same results.
res_mod_VR_TSST

preds <- predict(res_mod_VR_TSST, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_TSST, dat$yi, type="o", pch = 19, xlab = "VR Stressor", ylab = "Change in EDA", xaxt="n", bty = "l", main="SMC of EDA versus TSST or Non-TSST setting")
axis(side=1, at=1:2, labels=c("Non-TSST","TSST"))

#under 25 vs. over 25
VR_uo=as.factor(unlist(select(VR_study_sprdsht,c(108))))
res_mod_VR_uo <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_uo) #doesnt matter if weighted or not. Same results.
res_mod_VR_uo

preds <- predict(res_mod_VR_uo, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_uo, dat$yi, type="o", pch = 19, xlab = "VR Stressor", ylab = "Change in EDA", xaxt="n", bty = "l", main="SMC of EDA versus under-25 or over-25 years of age")
axis(side=1, at=1:2, labels=c("under-25","over-25"))

#Sample Size
SampleS=as.numeric(unlist(select(VR_study_sprdsht,c(90))))
res_mod_Stress_sample <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ SampleS)
res_mod_Stress_sample

regplot(res_mod_Stress_sample, mod="SampleS", xlab="Sample Size",
         refline=1, legend=TRUE, main="SMC of GSR versus Sample Size",)

```



```{r, fig.width=6,fig.height=4}

######### Systolic Blood Pressure ####################
#Calculate SBP effect size
SBP_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(76))))#baseline  #select the columns you want, then convert from list to numeric array
SBP_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(81)))) #peak #+5
SBP_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(77)) ))  #+1
SBP_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(82))))  #+6
SBP_ni=as.numeric(unlist(select(VR_study_sprdsht,c(85))))  #+9

dat <-escalc(measure="SMCC", ni=SBP_ni, m1i=SBP_m1i, m2i=SBP_m2i, sd1i=SBP_sd1i, sd2i=SBP_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 

res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

mes=paste("Standardized Mean Change in SBP (mmHg)")
taf <- trimfill(res) #trim-and-fill analysis
funnel(res, xlab=mes,legend=TRUE)
```

```{r, fig.width=10,fig.height=4}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(SBP_m2i, SBP_sd2i, SBP_m1i, SBP_sd1i, SBP_ni),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5, -2.5), 5.5, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-8.75,-5.25),     6, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-1.5, cex=0.75, mlab="")
text(-20, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.5, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))
res
res2
taf
taf2 <- trimfill(res2) #trim-and-fill analysis on FE
taf2
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```
```{r}
#### SBP MODERATORS ###


# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of SBP versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of SBP versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in SBP", xaxt="n", bty = "l", main="SMC of DBP versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
VR_medium=as.factor(unlist(select(VR_study_sprdsht,c(105))))
res_mod_VR_medium <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_medium) #doesnt matter if weighted or not. Same results.
res_mod_VR_medium
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_medium, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_medium, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in SBP", xaxt="n", bty = "l", main="SMC of DBP versus VR medium")
axis(side=1, at=1:2, labels=c("HMD","CAVE"))

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of SBP versus Year of Publication",)


#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in SBP", xaxt="n", bty = "l", main="SMC of SBP versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of SBP versus Subjective Stress of VR Simulation",)


```
```{r, fig.width=6,fig.height=4}

#########Diastolic Blood Pressure ####################
#Calculate DBP effect size
DBP_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(66))))#baseline  #select the columns you want, then convert from list to numeric array
DBP_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(71)))) #peak 
DBP_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(67)) )) 
DBP_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(72)))) 
DBP_ni=as.numeric(unlist(select(VR_study_sprdsht,c(75)))) 

dat <-escalc(measure="SMCC", ni=DBP_ni, m1i=DBP_m1i, m2i=DBP_m2i, sd1i=DBP_sd1i, sd2i=DBP_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 

res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

mes=paste("Standardized Mean Change in DBP (mmHg)")
taf <- trimfill(res) #trim-and-fill analysis
funnel(res, xlab=mes, legend=TRUE)
```

```{r, fig.width=10,fig.height=4}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(DBP_m2i, DBP_sd2i, DBP_m1i, DBP_sd1i, DBP_ni),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5, -2.5), 5.5, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-8.75,-5.25),     6, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-1.5, cex=0.75, mlab="")
text(-20, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.5, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))
res
res2
taf
taf2 <- trimfill(res2) #trim-and-fill analysis
taf2
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```
```{r}
#### DBP MODERATORS ###


# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of DBP versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of DBP versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in DBP", xaxt="n", bty = "l", main="SMC of DBP versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
VR_medium=as.factor(unlist(select(VR_study_sprdsht,c(105))))
res_mod_VR_medium <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_medium) #doesnt matter if weighted or not. Same results.
res_mod_VR_medium
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_medium, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_medium, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in DBP", xaxt="n", bty = "l", main="SMC of SBP versus VR medium")
axis(side=1, at=1:2, labels=c("HMD","CAVE"))

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of DBP versus Year of Publication",)

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in DBP", xaxt="n", bty = "l", main="SMC of DBP versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of DBP versus Subjective Stress of VR Simulation",)

```
```{r, fig.width=6,fig.height=4}

######### RSA ####################
#Calculate RSA effect size
RSA_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(56))))#baseline  #select the columns you want, then convert from list to numeric array
RSA_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(61)))) #peak #+5
RSA_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(57)) ))  #+1
RSA_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(62))))  #+6
RSA_ni=as.numeric(unlist(select(VR_study_sprdsht,c(65))))  #+9

dat <-escalc(measure="SMCC", ni=RSA_ni, m1i=RSA_m1i, m2i=RSA_m2i, sd1i=RSA_sd1i, sd2i=RSA_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 

res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

mes=paste("Standardized Mean Change in RSA (ms)")
#taf <- trimfill(res) #trim-and-fill analysis
funnel(res, xlab=mes, legend=TRUE)
```

```{r, fig.width=10,fig.height=3}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(RSA_m2i, RSA_sd2i, RSA_m1i, RSA_sd1i, RSA_ni),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5, -2.5), 4.5, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-8.75,-5.25),     5.3, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-1.6, cex=0.75, mlab="")
text(-20, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.6, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))
res
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```

```{r}
#### RSA MODERATORS ###


# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of RSA versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of RSA versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in RSA", xaxt="n", bty = "l", main="SMC of RSA versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
# NOTE: NO STUDIES USING CAVES MEASURED EDA, SO THIS ANALYSIS CANNOT BE PREFORMED

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of RSA versus Year of Publication",)

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
# NOTE: NO STUDIES USING VR/Video baseline measured RSA, SO THIS ANALYSIS CANNOT BE PREFORMED

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of RSA versus Subjective Stress of VR Simulation",)

```
```{r, fig.width=6,fig.height=4}

######### HRV LF/HF ####################
#Calculate LF/HF ratio effect size
HRV_LF_HF_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(36))))#baseline  #select the columns you want, then convert from list to numeric array
HRV_LF_HF_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(41)))) #peak #+5
HRV_LF_HF_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(37)) ))  #+1
HRV_LF_HF_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(42))))  #+6
HRV_LF_HF_ni=as.numeric(unlist(select(VR_study_sprdsht,c(45))))  #+9

dat <-escalc(measure="SMCC", ni=HRV_LF_HF_ni, m1i=HRV_LF_HF_m1i, m2i=HRV_LF_HF_m2i, sd1i=HRV_LF_HF_sd1i, sd2i=HRV_LF_HF_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 

res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

mes=paste("Standardized Mean Change in LF/HF (ms)")
#taf <- trimfill(res) #trim-and-fill analysis
funnel(res, xlab=mes, legend=TRUE)
```

```{r, fig.width=10,fig.height=3.5}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(HRV_LF_HF_m2i, HRV_LF_HF_sd2i, HRV_LF_HF_m1i, HRV_LF_HF_sd1i, HRV_LF_HF_ni),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5, -2.5), 6.5, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-8.75,-5.25),     7.3, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-1.5, cex=0.75, mlab="")
text(-20, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.5, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))
res
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```
```{r}
#### LF/HF MODERATORS ###


# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of LF/HF versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of LF/HF versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in LF/HF", xaxt="n", bty = "l", main="SMC of LF/HF versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
VR_medium=as.factor(unlist(select(VR_study_sprdsht,c(105))))
res_mod_VR_medium <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_medium) #doesnt matter if weighted or not. Same results.
res_mod_VR_medium
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_medium, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_medium, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in LF/HF", xaxt="n", bty = "l", main="SMC of LF/HF versus VR medium")
axis(side=1, at=1:2, labels=c("HMD","CAVE"))

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of LF/HF versus Year of Publication",)

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in LF/HF", xaxt="n", bty = "l", main="SMC of LF/HF versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of LF/HF versus Subjective Stress of VR Simulation",)


```

```{r, fig.width=6,fig.height=4}

######### HRV RMSSD ####################
#Calculate RMSSD effect size
HRV_RMSSD_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(46))))#baseline  #select the columns you want, then convert from list to numeric array
HRV_RMSSD_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(51)))) #peak #+5
HRV_RMSSD_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(47)) ))  #+1
HRV_RMSSD_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(52))))  #+6
HRV_RMSSD_ni=as.numeric(unlist(select(VR_study_sprdsht,c(55))))  #+9

dat <-escalc(measure="SMCC", ni=HRV_RMSSD_ni, m1i=HRV_RMSSD_m1i, m2i=HRV_RMSSD_m2i, sd1i=HRV_RMSSD_sd1i, sd2i=HRV_RMSSD_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 

res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

mes=paste("Standardized Mean Change in RMSSD (ms)")
#taf <- trimfill(res) #trim-and-fill analysis
funnel(res, xlab=mes, legend=TRUE)
```

```{r, fig.width=10,fig.height=4}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(HRV_RMSSD_m2i, HRV_RMSSD_sd2i, HRV_RMSSD_m1i, HRV_RMSSD_sd1i, HRV_RMSSD_ni),
       ilab.xpos=c(-12.5,-11,-9,-7.5, -5.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-12.5,-11,-9,-7.5, -5.5), 7.5, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-11.75,-8.25),     8.3, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-1.5, cex=0.75, mlab="")
text(-20, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.5, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))
res
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```
```{r}
#### RMSSD MODERATORS ###


# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of RMSSD versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
sex_male_per=as.numeric(unlist(select(VR_study_sprdsht,c(102))))
res_mod_male_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ sex_male_per)
res_mod_male_c

regplot(res_mod_male_c, mod="sex_male_per", xlab="Percent Male",
         refline=1, legend=TRUE, main="SMC of RMSSD versus Percewnt Male",)

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
sex_male_dum=as.factor(unlist(select(VR_study_sprdsht,c(100))))
res_mod_male_dum <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=sex_male_dum) #doesnt matter if weighted or not. Same results.
res_mod_male_dum
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_male_dum, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(sex_male_dum, dat$yi, type="o", pch = 19, xlab = "Group Sex Composition", ylab = "Change in RMSSD", xaxt="n", bty = "l", main="SMC of RMSSD versus Group Sex Composition")
axis(side=1, at=1:2, labels=c("all male","male+female, or all female"))

#Headset vs, CAVE
VR_medium=as.factor(unlist(select(VR_study_sprdsht,c(105))))
res_mod_VR_medium <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_medium) #doesnt matter if weighted or not. Same results.
res_mod_VR_medium
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_medium, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_medium, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in RMSSD", xaxt="n", bty = "l", main="SMC of RMSSD versus VR medium")
axis(side=1, at=1:2, labels=c("HMD","CAVE"))

#Year of publication
Year_pub=as.numeric(unlist(select(VR_study_sprdsht,c(4))))
res_mod_Year_pub <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Year_pub)
res_mod_Year_pub

regplot(res_mod_Year_pub, mod="Year_pub", xlab="Year of Publication",
         refline=1, legend=TRUE, main="SMC of RMSSD versus Year of Publication",)

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in RMSSD", xaxt="n", bty = "l", main="SMC of RMSSD versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of RMSSD versus Subjective Stress of VR Simulation",)



```

```{r, fig.width=6,fig.height=4}

######### Alpha Amylase ####################
#Calculate Alpha Amylase effect size
AA_m2i=as.numeric(unlist(select(VR_study_sprdsht,c(16))))#baseline  #select the columns you want, then convert from list to numeric array
AA_m1i=as.numeric(unlist(select(VR_study_sprdsht,c(21)))) #peak #+5
AA_sd2i=as.numeric(unlist(select(VR_study_sprdsht,c(17)) ))  #+1
AA_sd1i=as.numeric(unlist(select(VR_study_sprdsht,c(22))))  #+6
AA_ni=as.numeric(unlist(select(VR_study_sprdsht,c(25))))  #+9

dat <-escalc(measure="SMCC", ni=AA_ni, m1i=AA_m1i, m2i=AA_m2i, sd1i=AA_sd1i, sd2i=AA_sd2i, ri=rep.int(0.5, numrows)) #SMCC= Standardized mean change 

res2 <- rma(yi, vi, method="FE", data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))
res <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "))

mes=paste("Standardized Mean Change in Alpha Amylase (U/mL)")
#taf <- trimfill(res) #trim-and-fill analysis
funnel(res, xlab=mes, legend=TRUE)
```

```{r, fig.width=10,fig.height=3.5}
#forest(res,header=TRUE, cex=.8)
forest(res,xlim=c(-20,6), 
       ilab=cbind(AA_m2i, AA_sd2i, AA_m1i, AA_sd1i, AA_ni),
       ilab.xpos=c(-9.5,-8,-6,-4.5, -2.5), cex=.75,
       header="Author(s) and Year",
       mlab=" ")
op <- par(cex=.75, font=2)
text(c(-9.5,-8,-6,-4.5, -2.5), 4.8, c("M", "SD", "M", "SD", "N")) #6 denotes the height,posy
text(c(-8.75,-5.25),     5.4, c("Baseline", "Peak"))
par(op) # resets the plotting parameters.

#bottom labels
addpoly(res2, row=-1.5, cex=0.75, mlab="")
text(-20, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
     ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res$I2, digits=1, format="f")), "%)")))
text(-20, -1.5, pos=4, cex=0.75, bquote(paste("FE Model (Q = ",
     .(formatC(res2$QE, digits=2, format="f")), ", df = ", .(res2$k - res2$p),
     ", p = ", .(formatC(res2$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(res2$I2, digits=1, format="f")), "%)")))
res
res2
fsn(yi, vi, data=dat, weighted=TRUE, type="Orwin", target=.2) #how many non-signifcant studies to lower the effect to d=0.2
```

```{r}
#### AA MODERATORS ###


# Age was ﬁrst analyzed as a continuous variable. Weighted regression analyses using mean age of participants as the predictor variable was performed on the study data.
age=as.numeric(unlist(select(VR_study_sprdsht,c(96))))
res_mod_age_c <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods=~age)
res_mod_age_c

regplot(res_mod_age_c, mod="age", xlab="Age (years)",
         refline=1, legend=TRUE, main="SMC of AA versus Age",)

# Sex was ﬁrst analyzed as a continuous variable as percentage of male participants. Weighted regression analyses using percent male participants as the predictor variable was performed on the study data.
#NOTE: CANT DO ANALYSIS, AA papers only have males. No females.

# Sex were split into two groups, including a group with studies including only male participants (n = 6), and a group of studies including either participants with both sexes (n = 5) or only female participants (n = 2).
#NOTE: CANT DO ANALYSIS, AA papers only have males. No females.

#Headset vs, CAVE
#NOTE: CANT DO ANALYSIS. No papers with caves.

#Year of publication
#NOTE: CANT DO ANALYSIS, All papers were published in 2019.

#Baseline Traditional vs During Video/VR
VR_baseline=as.factor(unlist(select(VR_study_sprdsht,c(104))))
res_mod_VR_baseline <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), mods=VR_baseline) #doesnt matter if weighted or not. Same results.
res_mod_VR_baseline
#QM is  if the moderator level is significantly different, between-group main effect 2xgroup(male, male+female & females)
#QE is the homogeneity test that calculated for variability within each group
#according to Helminen, 2019 QM=QB, QE=QW)

preds <- predict(res_mod_VR_baseline, newmods = cbind(0:60))
wi <- 1/sqrt(dat$vi)
size <- 0.5 + 3 * (wi - min(wi, na.rm = TRUE))/(max(wi, na.rm = TRUE) - min(wi, na.rm = TRUE))
plot(VR_baseline, dat$yi, type="o", pch = 19, xlab = "VR medium", ylab = "Change in AA", xaxt="n", bty = "l", main="SMC of AA versus baseline setting")
axis(side=1, at=1:2, labels=c("Traditional","VR/video"))

#Stress Anchors
Stress_anchor=as.numeric(unlist(select(VR_study_sprdsht,c(106))))
res_mod_Stress_anchor <- rma(yi, vi, data=dat, slab=paste(VR_study_sprdsht$Authors, VR_study_sprdsht$Year, sep=", "), weighted=TRUE, mods= ~ Stress_anchor)
res_mod_Stress_anchor

regplot(res_mod_Stress_anchor, mod="Stress_anchor", xlab="Subjective Stress",
         refline=1, legend=TRUE, main="SMC of AA versus Subjective Stress of VR Simulation",)

```